<div class="order-list">
  <div class="header-with-button">
    <h2>Orders</h2>
    <app-add-button
      [isOpen]="showAddForm()"
      [ariaLabel]="showAddForm() ? 'Close add order form' : 'Open add order form'"
      (clicked)="toggleAddForm()"
    ></app-add-button>
  </div>

  @if (showAddForm()) {
    <app-order-form
      [studentId]="studentId"
      [order]="editingOrder()"
      (orderCreated)="onOrderCreated($event)"
      (orderUpdated)="onOrderUpdated($event)"
      (cancelled)="onFormCancelled()"
    ></app-order-form>
  } @else {
    <div class="filter-bar">
      <select
        class="filter-select"
        [ngModel]="filterStatus()"
        (ngModelChange)="filterStatus.set($event)"
      >
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="paid">Paid</option>
      </select>
      <input
        type="number"
        class="filter-input"
        placeholder="Min $"
        [ngModel]="filterMinTotal()"
        (ngModelChange)="filterMinTotal.set($event)"
        (keyup.enter)="onFilter()"
      />
      <input
        type="number"
        class="filter-input"
        placeholder="Max $"
        [ngModel]="filterMaxTotal()"
        (ngModelChange)="filterMaxTotal.set($event)"
        (keyup.enter)="onFilter()"
      />
      <button class="filter-btn" (click)="onFilter()">Filter</button>
      @if (hasActiveFilters()) {
        <button class="clear-btn" (click)="clearFilters()">Clear</button>
      }
    </div>

    @if (loading()) {
      <div class="skeleton-table">
        <div class="skeleton-header-row">
          @for (i of [1, 2, 3, 4, 5]; track i) {
            <div class="skeleton-cell header"></div>
          }
        </div>
        @for (i of [1, 2, 3, 4, 5]; track i) {
          <div class="skeleton-row">
            @for (j of [1, 2, 3, 4, 5]; track j) {
              <div class="skeleton-cell"></div>
            }
          </div>
        }
      </div>
    }

    @if (errorMessage()) {
      <div class="error-message">
        {{ errorMessage() }}
      </div>
    }

    @if (!loading() && orders().length === 0 && !errorMessage()) {
      <div class="empty-state">
        @if (hasActiveFilters()) {
          <p>No orders match your filter criteria.</p>
          <button class="clear-filters-btn" (click)="clearFilters()">Clear filters</button>
        } @else {
          <p>No orders found. Click + to add your first order.</p>
        }
      </div>
    }

    @if (!loading() && !errorMessage() && orders().length > 0) {
      <div class="orders-table-container">
        <table class="orders-table">
          <thead>
            <tr>
              <th class="sortable" (click)="sortBy('id')">
                Order ID
                <span class="sort-icon">{{ getSortIcon('id') }}</span>
              </th>
              <th class="sortable" (click)="sortBy('total')">
                Total
                <span class="sort-icon">{{ getSortIcon('total') }}</span>
              </th>
              <th class="sortable" (click)="sortBy('status')">
                Status
                <span class="sort-icon">{{ getSortIcon('status') }}</span>
              </th>
              <th class="sortable" (click)="sortBy('createdAt')">
                Date
                <span class="sort-icon">{{ getSortIcon('createdAt') }}</span>
              </th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (order of orders(); track order.id) {
              <tr>
                <td>#{{ order.id }}</td>
                <td class="total">{{ order.total | currency:'USD' }}</td>
                <td>
                  <button
                    class="status-badge"
                    [class]="'status-' + order.status"
                    (click)="toggleStatus(order)"
                    [attr.aria-label]="'Change status from ' + order.status"
                  >
                    {{ order.status }}
                  </button>
                </td>
                <td class="date">{{ order.createdAt | date }}</td>
                <td class="actions">
                  <button
                    class="edit-btn"
                    (click)="editOrder(order)"
                    aria-label="Edit order"
                  >
                    Edit
                  </button>
                  @if (order.id) {
                    <button
                      class="delete-btn"
                      (click)="deleteOrder(order.id)"
                      aria-label="Delete order"
                    >
                      Delete
                    </button>
                  }
                </td>
              </tr>
            }
          </tbody>
          @if (orders().length > 1) {
            <tfoot>
              <tr class="total-row">
                <td colspan="1"><strong>Total:</strong></td>
                <td colspan="4" class="grand-total">
                  <strong>{{ getTotalAmount() | currency:'USD' }}</strong>
                </td>
              </tr>
            </tfoot>
          }
        </table>
      </div>

      <app-pagination
        [currentPage]="currentPage()"
        [totalPages]="totalPages()"
        [totalElements]="totalElements()"
        [pageSize]="pageSize()"
        (pageChange)="onPageChange($event)"
      ></app-pagination>
    }
  }
</div>
